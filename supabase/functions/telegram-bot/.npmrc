import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const BOT_TOKEN = Deno.env.get('TELEGRAM_BOT_TOKEN')
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')

const supabase = createClient(SUPABASE_URL!, SUPABASE_SERVICE_ROLE_KEY!)

serve(async (req) => {
  try {
    const payload = await req.json()
    console.log("Payload primit:", JSON.stringify(payload))

    // CAZ 1: Notificare automatÄƒ din Baza de Date (Webhook)
    if (payload.record && payload.table) {
      // Presupunem cÄƒ tabelul tÄƒu are o coloanÄƒ 'user_id'
      const { data: profile } = await supabase
        .from('profiles')
        .select('telegram_chat_id')
        .eq('id', payload.record.user_id)
        .single()

      if (profile?.telegram_chat_id) {
        const mesaj = `ðŸš¨ <b>Match Found!</b>\n\n` +
                      `Meci: ${payload.record.home_team} vs ${payload.record.away_team}\n` +
                      `Cota: ${payload.record.odds}\n` +
                      `Scor: ${payload.record.score}`;
        
        await sendToTelegram(profile.telegram_chat_id, mesaj)
      }
      return new Response("Webhook processed", { status: 200 })
    }

    // CAZ 2: Mesaj direct de la utilizator Ã®n Telegram
    const chatId = payload.message?.chat?.id
    const text = payload.message?.text

    if (text === "/start") {
      await sendToTelegram(chatId, `Salut! Chat ID-ul tÄƒu este: <code>${chatId}</code>\nIntrodu-l Ã®n aplicaÈ›ie pentru activare.`, {
        parse_mode: 'HTML'
      })
    }

    return new Response(JSON.stringify({ ok: true }), { status: 200 })
  } catch (err) {
    return new Response(JSON.stringify({ error: err.message }), { status: 200 })
  }
})

async function sendToTelegram(chatId: any, text: string, options = {}) {
  await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ chat_id: chatId, text, parse_mode: 'HTML', ...options })
  })
}